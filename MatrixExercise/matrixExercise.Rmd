---
title: "Exercise"
author: "Vildsvinegruppen"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = F, eval = F)

library(tidyverse)
library(magrittr)
library(extrafont)

sampleFromDist <- function(D, n = 1) {
  
  if (!all(names(D) == c("distribution", "parameters"))) stop("Incorrect distribution object.")
  
  if (tolower(D$distribution) == "gamma") {
    rgamma(n, shape = D$parameters[1], rate = D$parameters[2])
  }
  else if (tolower(D$distribution) == "beta") {
    rbeta(n, shape1 = D$parameters[1], shape2 = D$parameters[2])
  }
  else {
    stop(paste0("Unknown distribution:", D$distribution))
  }
}

calcLambda <- function(param) {
  do.call(constructMatrix, param) %>% 
    eigen() %$%
    values %>% 
    first %>% 
    Re
}
```

# Question

How large is the maximal sustainable hunting pressure on wild boars in Tofte Skov?

## Phenology Parameters
We use the phenological parameters from the \cite{Croft2020}:

```{r, echo = T}
Fecundity <- list(distribution = "Gamma", parameters = c(47.4, 8.66))
SexRatio <- list(distribution = "Beta", parameters = c(31.2, 29.2))
SurvivalFemale <- list(distribution = "Beta", parameters = c(2.89, 1.46))
SurvivalJuveniles <- list(distribution = "Beta", parameters = c(1.92, 1.54))
SurvivalMale <- list(distribution = "Beta", parameters = c(2.82, 1.55))
```

## Population Transition Matrix

As well as the transition matrix formulation:

$$\mathbf{A}_t = \begin{bmatrix}
0 & s_2 F_t & 0 \\
s_1 m & s_2 & 0 \\
s_1 (1 - m) & 0 & s_2
\end{bmatrix}$$
where $s_1, s_2, s_3$ are juvenile, female \& male survival rates respectively, while $m$ is the sex-ratio and $F_t$ is the fecundity at time $t$. If fecundity is density dependent (as in \cite{Croft2020}) then:

$$F_t = f_0 e^{\frac{-\sum(\mathbf{n}-\mathbf{r})_t}{k}}$$
otherwise:
$$F_t = f_0$$
We also adapt the formulation of stochastic growth as \cite{Croft2020}:

$$\log(\mathbf{n}_{t+1}) \sim N\left(\log\left(\mathbf{A}_t(\mathbf{n}-\mathbf{r})_t\right),\sigma_i^2\right)$$

Where the cohort stratified population size is sampled from an essentially quasi-poisson distribution.

The code for constructing the matrix:

```{r, echo = T}
constructMatrix <- function(Pop, Fec, SR, Sj, Sf, Sm, K, h) {
  ## Pop: Population structure after removal
  ## Fec: Fecundity
  ## SR : Sex Ratio
  ## Sj : Survival juveniles
  ## Sf : Survival female
  ## Sm : survival male
  ## K  : Carrying capacity
  ## h  ; hunting pressure
  
  TM <- matrix(0, nrow = 3, ncol = 3)
  
  # Juveniles born
  TM[1, 2] <- Sf * Fec * exp(-sum(Pop)/K)
  
  # Juveniles maturing to females
  TM[2, 1] <- Sj * SR
  
  # Juveniles maturing to males
  TM[3, 1] <- Sj * (1 - SR)
  
  # Adult female surval
  TM[2, 2] <- Sf
  
  # Adult male survival
  TM[3, 3] <- Sm
  
  if (!missing(h)) {
    TM - matrix(rep(h, 3), ncol = 3)
  } 
  else {
    TM
  }
}

sampleParam <- function(Pop = c(50, 70, 30), K = 4*800, h = c(0, 0, 0)) {
  list(
    Fec = Fecundity %>% 
      sampleFromDist,
    SR = SexRatio %>% 
      sampleFromDist,
    Sf = SurvivalFemale %>% 
      sampleFromDist,
    Sm = SurvivalMale %>% 
      sampleFromDist,
    Sj = 0.364#SurvivalJuveniles %>% 
    #sampleFromDist,
    ,
    Pop = Pop,
    K = K,
    h = h
  )
}
```

# Non-Stochastic Growth

```{r, echo = F}
library(furrr)
library(colorspace)
library(metR)
library(geomtextpath)

plan("multisession", workers = 8)
juvenileFemaleHunting <- tibble(
  f = seq(0, 0.2, length.out = 25),
  j = seq(0, 0.5, length.out = 25)
) %>% 
  complete(f, j) %>% 
  slice(rep(1:n(), 200)) %>% 
  mutate(
    lambda = future_map2_dbl(f,j, function(hF, hJ) {
      sampleParam(h = c(hJ, hF, 0)) %>% 
        calcLambda
    })
  )
plan("sequential")

tValueStat <- function(x) {
  mod          <- lm(x ~ 1)
  coefficients <- summary(mod)$coefficients[1, ]
  
  t.value      <- coefficients[3] %>% 
    unname %>% 
    unclass
  
  t.value
}

juvenileFemaleHuntingPlt <- juvenileFemaleHunting %>%
  group_by(cut_width(f, 0.015, boundary = 0), cut_width(j, 0.04, boundary = 0)) %>%
  summarize(across(!lambda, min),
            lambda = mean(lambda),
            .groups = "drop") %>%
  ggplot(aes(j, f, z = lambda)) +
  geom_contour_fill(breaks = seq(-2, 2, .1),
                    aes(fill = after_stat(level_high),
                        color = after_scale(fill))) +
  geom_contour2(aes(label = after_stat(format(level, nsmall = 1))),
                skip = 0,
                label.placer = isoband::label_placer_manual(
                  # This is just done because I for my OCD's sake;
                  # I think it looks better when the contour labels are aligned
                  breaks = rev(seq(.5, 1.1, .1)), # label values (i.e. what number should be displayed)
                  x = c(rep(.075,5), 0.7, 0.875), # label x-coordinate (panel coordinates NOT data)
                  y = c(0.085, 0.24, 0.375, 0.525, 0.807, 0.753, 0.753),  # label y-coordinate (panel coordinates NOT data)
                  theta = rep(0, 7) # label text angle (0 = no rotation)
                ),
                family = "CMU Serif",
                fontface = "bold",
                margin = margin(2,2,2,2, "mm")) +
  colorspace::scale_fill_continuous_diverging(palette = "Blue-Red 2", 
                                              mid = 1,
                                              rev = T,
                                              breaks = seq(0.5, 1.2, .1)) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(labels = scales::label_percent()) +
  coord_equal(expand = F) +
  guides(fill = guide_colorbar(
    ticks.colour = "black",
    ticks.linewidth = .25,
    frame.colour = "black",
    frame.linewidth = .5,
  )) +
  ggpubr::theme_pubr(legend = "right", base_family = "CMU Serif") +
  labs(x = "Juvenile Hunting Pressure", 
       y = "Female Hunting Pressure", 
       fill = latex2exp::TeX("Population\nGrowth Rate ($\\lambda$)")) + 
  theme(title = element_text(face = "bold",
                             size = 14),
        axis.title.x = element_text(margin = margin(6,0,0,0,"mm")),
        axis.title.y = element_text(margin = margin(0,4,0,0,"mm")),
        legend.text = element_text(size = 12),
        legend.title = element_text(margin = margin(0,0,0,-11,"mm"), # This margin is added to allow centering of the wide legend title
                                    size = 18),
        aspect.ratio = 1,
        legend.box.margin = margin(0, 0, -5.7, 12, "mm"),            # \|/ Likewise
        legend.key.height = unit(16, "mm"),
        legend.key.width = unit(15, "mm"),
        legend.box.spacing = unit(1, "mm"))

ggsave("juvenileFemaleHuntingPressure.pdf", juvenileFemaleHuntingPlt,
       device = cairo_pdf, width = 4, height = 3, scale = 2)
```


```{r, echo = F}
library(popbio)


sampleParam()
```

